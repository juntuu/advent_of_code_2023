#!/usr/bin/awk -f

function g(c,d){n=d?g(d,c%d):x*=n/c}!N{N=split($0,I,z)
}function m(a,p){$0=a;for(x=1;$++a;g(x,n))while($a!~p)
$a=G[I[n++%N+1]$a];print x}END{m("AAA","ZZZ")m(B,"Z$")
}G["L"$1]=$gsub(/[$--]/,z){G["R"$1]=$4}/^..A/{B=B$1FS}
